<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/extensions/http_api/definitions.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/extensions/http_api/definitions.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;

const { expect } = require(&apos;chai&apos;)
const _ = require(&apos;lodash&apos;)

const Cast = require(&apos;../../cast&apos;)
const Helper = require(&apos;../../helper&apos;)

module.exports = ({ baseUrl = &apos;&apos; }) =&gt; ({ Given, When, Then }) =&gt; {
    /**
     * Setting http headers
     */
    Given(/^I set request headers$/, function(step) {
        this.httpApiClient.setHeaders(Cast.object(this.state.populateObject(step.rowsHash())))
    })

    /**
     * Setting a single http header
     */
    Given(/^I set ([a-zA-Z0-9-]+) request header to (.*)$/, function(key, value) {
        this.httpApiClient.setHeader(key, Cast.value(this.state.populate(value)))
    })

    /**
     * Setting json payload
     */
    Given(/^I set request json body$/, function(step) {
        this.httpApiClient.setJsonBody(Cast.object(this.state.populateObject(step.rowsHash())))
    })

    /**
     * Setting form data
     */
    Given(/^I set request form body$/, function(step) {
        this.httpApiClient.setFormBody(Cast.object(this.state.populateObject(step.rowsHash())))
    })

    /**
     * Setting query parameters
     */
    Given(/^I set request query$/, function(step) {
        this.httpApiClient.setQuery(Cast.object(this.state.populateObject(step.rowsHash())))
    })

    Given(/^I pick response json (.*) as (.*)$/, function(path, key) {
        const response = this.httpApiClient.getResponse()
        const body = response.body

        this.state.set(key, _.get(body, path))
    })

    /**
     * Resetting the client&apos;s state
     */
    When(/^I reset http client/, function() {
        this.httpApiClient.reset()
    })

    /**
     * Performing a request
     */
    When(/^I (GET|POST|PUT|DELETE) (.*)$/, function(method, path) {
        return this.httpApiClient.makeRequest(method, this.state.populate(path), baseUrl)
    })

    /**
     * Dumping response body
     */
    When(/^I dump response body$/, function() {
        const httpResponse = this.httpApiClient.getResponse()
        console.log(httpResponse.body) // eslint-disable-line no-console
    })

    /**
     * Checking response status code
     */
    Then(/^I should receive a ([1-5][0-9][0-9]) HTTP status code$/, function(statusCode) {
        const httpResponse = this.httpApiClient.getResponse()
        expect(httpResponse).to.not.be.empty
        expect(httpResponse.statusCode).to.equal(Number(statusCode))
    })

    /**
     * This definition can be used for checking an object response.
     * It check that the properties of this object match with the expected properties
     * The columns header are | field | matcher | value |
     * You can define severals matchers :
     * - equals
     * - contains
     */
    Then(/^I should receive a json response (fully )?matching/, function(fully, table) {
        const response = this.httpApiClient.getResponse()
        const body = response.body

        const expectedProperties = Cast.objects(table.hashes())

        // We check the response has json content-type
        expect(response.headers[&apos;content-type&apos;]).to.contain(&apos;application/json&apos;)

        // We check response properties correspond to the expected response
        expectedProperties.forEach(propertyMatcher =&gt; {
            switch (propertyMatcher.matcher) {
                case &apos;contains&apos;:
                    expect(_.get(body, propertyMatcher.field)).to.contain(propertyMatcher.value)
                    break
                case &apos;equals&apos;:
                default:
                    expect(_.get(body, propertyMatcher.field)).to.be.equal(propertyMatcher.value)
            }
        })

        // We check we have exactly the same number of properties as expected
        if (fully) {
            const propertiesCount = Helper.countNestedProperties(body)
            expect(propertiesCount).to.be.equal(table.hashes().length)
        }
    })

    /**
     * This definition verify that an array for a given path has the expected length
     */
    Then(/^I should receive a collection of (\d+) items for path &apos;(.*)&apos;/, function(itemsNumber, path) {
        const { body } = this.httpApiClient.getResponse()
        const array = _.get(body, path)

        expect(array.length).to.be.equal(Number(itemsNumber))
    })
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
